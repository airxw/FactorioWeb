<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factorio Server Pro</title>
    <link rel="stylesheet" href="static/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/lib/xterm/css/xterm.css">
    <link rel="stylesheet" href="static/lib/bootstrap/bootstrap-icons.css">
    <link id="skin-style" rel="stylesheet" href="">

    <style>
        /* === 核心变量 === */
        :root {
            --primary: #3b82f6; 
            --primary-dark: #2563eb;
            --primary-light: #60a5fa;
            --success: #10b981;
            --success-light: #34d399;
            --danger: #ef4444;
            --danger-light: #f87171;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --info: #06b6d4;
            --info-light: #22d3ee;
            --bg-body: #f3f4f6; 
            --bg-sidebar: #ffffff; 
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --bg-input-border: #e5e7eb;
            --border-color: #e5e7eb;
            --text-primary: #374151;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --sidebar-width: 460px; 
        }
        
        body, html { 
            height: 100%; 
            margin: 0; 
            background: var(--bg-body); 
            font-family: 'Microsoft YaHei', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            overflow: hidden; 
            font-size: 14px; 
            color: var(--text-primary); 
        }
        
        /* === 布局框架 === */
        .layout-container { 
            display: flex; 
            height: 100vh; 
            width: 100%; 
        }
        .sidebar { 
            width: var(--sidebar-width); 
            min-width: var(--sidebar-width); 
            background: var(--bg-sidebar); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            z-index: 20; 
            box-shadow: 4px 0 12px rgba(0,0,0,0.02); 
            transition: all 0.3s ease;
        }
        .sidebar-header { 
            padding: 0 24px; 
            height: 64px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 1px solid var(--border-color); 
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-sidebar) 100%);
        }
        .sidebar-body { 
            flex: 1; 
            overflow-y: auto; 
            padding: 24px; 
            background: var(--bg-sidebar); 
        }
        .main-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-width: 0; 
            background: #000; 
        }
        
        /* === UI 组件 === */
        .card { 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            background: var(--bg-card); 
            margin-bottom: 16px; 
            overflow: hidden; 
            transition: all 0.2s ease;
        }
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .card-header { 
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-body) 100%); 
            border-bottom: 1px solid var(--border-color); 
            padding: 12px 16px; 
            font-weight: 600; 
            color: var(--text-secondary); 
        }
        .card-body { 
            padding: 16px; 
        }
        .nav-pills .nav-link { 
            color: var(--text-secondary); 
            font-weight: 500; 
            border-radius: 8px; 
            padding: 10px 16px; 
            margin-right: 4px; 
            transition: all 0.2s; 
        }
        .nav-pills .nav-link:hover {
            background: var(--bg-body);
            color: var(--text-primary);
        }
        .nav-pills .nav-link.active { 
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%); 
            color: #ffffff; 
            font-weight: 600; 
        }
        .btn { 
            border-radius: 8px; 
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
        }
        .form-control, .form-select { 
            border-radius: 8px; 
            border: 2px solid var(--bg-input-border);
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59,130,246,0.1);
        }
        
        /* === 终端与探针 === */
        .term-container { 
            flex: 1; 
            background: #1e1e1e; 
            position: relative; 
            border-bottom: 1px solid #333; 
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .term-header { 
            height: 44px; 
            background: linear-gradient(180deg, #2d2d2d 0%, #252526 100%); 
            color: #999; 
            border-bottom: 1px solid #333; 
            display: flex; 
            align-items: center; 
            padding: 0 18px; 
            justify-content: space-between; 
            font-size: 0.85rem; 
            flex-shrink: 0;
        }
        .term-body { 
            flex: 1; 
            position: relative; 
            min-height: 0;
        } 
        #terminal { 
            width: 100%; 
            height: 100%; 
        }
        
        /* === 雅黑探针风格 === */
        .monitor-container { 
            background: var(--bg-card); 
            display: flex; 
            flex-direction: column; 
            max-height: 200px;
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        .monitor-container.collapsed {
            max-height: 44px;
        }
        .probe-header { 
            padding: 10px 20px; 
            background: linear-gradient(135deg, var(--bg-body) 0%, var(--bg-card) 100%); 
            border-bottom: 1px solid var(--border-color); 
            font-weight: bold; 
            color: var(--text-secondary); 
            display: flex; 
            justify-content: space-between; 
            cursor: pointer;
            user-select: none;
        }
        .probe-header:hover {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-input) 100%);
        }
        .probe-body { 
            flex: 1; 
            padding: 0 20px; 
            overflow-y: auto; 
            display: flex; 
            align-items: center; 
        }
        .yh-table { 
            width: 100%; 
            font-size: 0.9rem; 
            border-collapse: separate; 
            border-spacing: 0 12px; 
        }
        .yh-label { 
            width: 80px; 
            font-weight: 600; 
            color: var(--text-secondary); 
            text-align: right; 
            padding-right: 15px; 
        }
        .yh-bar-cell { 
            width: 45%; 
        }
        .yh-val-cell { 
            width: 25%; 
            color: var(--text-primary); 
            font-family: Consolas, 'SF Mono', monospace; 
            padding-left: 10px; 
        }
        .progress-yh { 
            height: 18px; 
            background: var(--bg-input-border); 
            border-radius: 6px; 
            overflow: hidden; 
            position: relative; 
        }
        .progress-yh .bar { 
            height: 100%; 
            transition: width 0.5s ease; 
            border-radius: 6px;
        }
        .bar-cpu { 
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); 
        } 
        .bar-mem { 
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%); 
        } 
        .bar-buf { 
            background: linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%); 
        } 
        .bar-cache { 
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); 
        } 
        .bar-disk { 
            background: linear-gradient(90deg, #6366f1 0%, #818cf8 100%); 
        }
        
        /* === Mod列表与物品库 === */
        .mod-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 14px; 
            border-bottom: 1px solid var(--border-color); 
            transition: background 0.2s;
        }
        .mod-item:hover {
            background: var(--bg-body);
        }
        .mod-item:last-child { 
            border-bottom: none; 
        }
        .item-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 12px; 
            max-height: 60vh; 
            overflow-y: auto; 
            padding: 12px; 
        }
        .item-btn { 
            text-align: left; 
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
            padding: 10px; 
            font-size: 0.85rem; 
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .item-btn:hover {
            border-color: var(--primary);
            background: var(--bg-body);
            color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59,130,246,0.15);
        }

        #toast-container { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 9999; 
        }
        .d-none { 
            display: none !important; 
        }
        
        /* 彻底消灭 xterm 那条烦人的横向滚动条 */
        #terminal .xterm-viewport {
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        #terminal .xterm-screen {
            min-width: 100% !important;
            width: auto !important;
        }
        .xterm .xterm-helpers {
            position: absolute;
            top: 0;
        }
        
        /* === 响应式设计 === */
        @media (max-width: 1200px) {
            :root {
                --sidebar-width: 400px;
            }
        }
        
        @media (max-width: 992px) {
            body, html {
                overflow: auto;
            }
            .layout-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            .sidebar {
                width: 100%;
                min-width: 100%;
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            .sidebar-body {
                max-height: 500px;
            }
            .main-content {
                min-height: 600px;
            }
            .term-container {
                height: 400px;
            }
            .monitor-container {
                height: auto;
                min-height: 200px;
            }
            .yh-table {
                border-spacing: 0 8px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar-header {
                padding: 0 16px;
                height: 56px;
            }
            .sidebar-body {
                padding: 16px;
            }
            .item-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
                padding: 8px;
            }
            .yh-label {
                width: 60px;
                font-size: 0.8rem;
            }
            .yh-val-cell {
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 576px) {
            .nav-pills .nav-link {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            .term-header {
                padding: 0 12px;
                height: 38px;
            }
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-body);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>

<div class="layout-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="d-flex align-items-center text-primary"><i class="bi bi-hdd-rack-fill fs-4 me-2"></i><span class="fw-bold fs-5">Factorio Pro</span></div>
            <div class="d-flex align-items-center gap-2">
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="skinDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="切换皮肤">
                        <i class="bi bi-palette"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="skinDropdown">
                        <li><a class="dropdown-item" href="#" onclick="setSkin('default')"><i class="bi bi-sun me-2"></i>默认风格</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setSkin('industrial')"><i class="bi bi-palette me-2"></i>现代风格</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setSkin('factorio')"><i class="bi bi-gear me-2"></i>Factorio风格</a></li>
                    </ul>
                </div>
                <span id="server-status-badge" class="badge bg-secondary">连接中...</span>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()" title="退出登录"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>
        
        <div class="sidebar-body">
            <ul class="nav nav-pills nav-fill mb-4" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-control">控制</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mods">模组</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-players">玩家</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-files">文件</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-control">
                    <div id="stop-area" class="d-none">
                        <div class="card border-success bg-success bg-opacity-10 mb-4">
                            <div class="card-body text-center py-4">
                                <div class="mb-3 text-success"><i class="bi bi-check-circle-fill display-4"></i></div>
                                <h5 class="fw-bold text-success mb-3">服务器正常运行中</h5>
                                <div class="d-flex gap-2 justify-content-center">
                                    <button onclick="saveGame()" class="btn btn-success"><i class="bi bi-save me-1"></i>存档</button>
                                    <button onclick="controlServer('stop')" class="btn btn-danger"><i class="bi bi-power me-1"></i>停止</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="startForm" class="d-none">
                        <div class="card mb-4">
                            <div class="card-header"><i class="bi bi-sliders me-2"></i>启动配置</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-muted">服务端版本</label>
                                    <div class="input-group">
                                        <select name="version" id="version-select" class="form-select"></select>
                                        <button type="button" class="btn btn-light border" onclick="checkUpdate()" title="检查更新"><i class="bi bi-cloud-arrow-down"></i></button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-muted">地图存档 (.zip)</label>
                                    <div class="input-group">
                                        <select name="map" id="map-select" class="form-select"><option disabled>加载中...</option></select>
                                        <button type="button" class="btn btn-light border" onclick="refreshMapList()"><i class="bi bi-arrow-repeat"></i></button>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label small fw-bold text-muted">配置文件 (.json)</label>
                                    <div class="input-group">
                                        <select name="config" id="config-select" class="form-select"><option disabled>加载中...</option></select>
                                        <a href="config-editor.php" target="_blank" class="btn btn-light border" title="编辑配置"><i class="bi bi-pencil"></i></a>
                                        <button type="button" class="btn btn-light border" onclick="refreshConfigList()"><i class="bi bi-arrow-repeat"></i></button>
                                    </div>
                                </div>
                                <button type="button" onclick="controlServer('start')" class="btn btn-primary w-100 py-2"><i class="bi bi-play-fill me-1"></i>启动服务器</button>
                            </div>
                        </div>
                    </form>
                    <div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-clock-history me-2"></i>历史存档（点击即可切换/回档）
        <button class="btn btn-sm btn-outline-secondary float-end" onclick="refreshMapList()">
            <i class="bi bi-arrow-repeat"></i>
        </button>
    </div>
    <div class="list-group list-group-flush" id="save-history" style="max-height:300px;overflow-y:auto"></div>
</div>
                    <div class="text-center text-muted small mt-3">
                        <span id="server-address" class="font-monospace">获取 IP 中...</span>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-mods">
                    <button class="btn btn-success w-100 mb-3" data-bs-toggle="modal" data-bs-target="#modPortalModal"><i class="bi bi-cloud-download me-2"></i>打开 Mod 门户</button>
                    <div class="card">
                        <div class="card-body p-2">
                            <div class="input-group input-group-sm">
                                <input type="file" id="mod-upload-input" class="form-control" multiple accept=".zip">
                                <button class="btn btn-primary" onclick="uploadMod()">本地上传</button>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
                        <span class="fw-bold small text-muted">已安装列表</span>
                        <div class="input-group input-group-sm w-50">
                            <input type="text" id="local-mod-filter" class="form-control" placeholder="筛选..." onkeyup="filterLocalMods()">
                            <button class="btn btn-light border" onclick="loadMods()"><i class="bi bi-arrow-repeat"></i></button>
                        </div>
                    </div>
                    <div id="mod-list" class="bg-white border rounded" style="min-height: 200px; max-height: 500px; overflow-y: auto;"></div>
                </div>

                <div class="tab-pane fade" id="tab-players">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" id="target-player" class="form-control" placeholder="输入玩家名...">
                        <button class="btn btn-outline-secondary" onclick="loadPlayerLists()"><i class="bi bi-arrow-repeat"></i></button>
                    </div>
                    
                    <div class="row g-2 mb-4">
                        <div class="col-6"><button class="btn btn-outline-danger w-100" onclick="doAction('ban')">封禁 (Ban)</button></div>
                        <div class="col-6"><button class="btn btn-outline-warning w-100" onclick="doAction('kick')">踢出 (Kick)</button></div>
                        <div class="col-6"><button class="btn btn-outline-success w-100" onclick="doAction('promote')">设为管理</button></div>
                        <div class="col-6"><button class="btn btn-outline-secondary w-100" onclick="doAction('unban')">解封</button></div>
                        <div class="col-6"><button class="btn btn-outline-primary w-100" onclick="doAction('wl-add')">+ 加白名单</button></div>
                        <div class="col-6"><button class="btn btn-outline-dark w-100" onclick="doAction('wl-remove')">- 移出白名单</button></div>
                    </div>
                    
                    <div class="card border-info mb-4">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-gift me-2"></i>给予物品</span>
                            <button class="btn btn-sm btn-light py-0 text-primary fw-bold" data-bs-toggle="modal" data-bs-target="#itemModal">打开物品库</button>
                        </div>
                        <div class="card-body bg-light">
                            <div class="input-group mb-2">
                                <span class="input-group-text bg-white">物品代码</span>
                                <input type="text" id="gift-item" class="form-control" placeholder="例如: iron-plate">
                            </div>
                            <div class="input-group">
                                <span class="input-group-text bg-white">数量</span>
                                <input type="number" id="gift-count" class="form-control" value="100" min="1">
                                <button class="btn btn-info text-white" onclick="doGift()">发送</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion accordion-flush border rounded mb-3" id="plAcc">
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#ls-admin">管理员</button></h2><div id="ls-admin" class="accordion-collapse collapse" data-bs-parent="#plAcc"><div class="list-group list-group-flush" id="list-admins"></div></div></div>
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#ls-white">白名单</button></h2><div id="ls-white" class="accordion-collapse collapse" data-bs-parent="#plAcc"><div class="list-group list-group-flush" id="list-whitelist"></div></div></div>
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#ls-ban">封禁名单</button></h2><div id="ls-ban" class="accordion-collapse collapse" data-bs-parent="#plAcc"><div class="list-group list-group-flush" id="list-bans"></div></div></div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-files">
                    <div class="card mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2"><label class="fw-bold small text-muted">快速上传</label><span class="badge bg-light text-secondary border">支持 .zip / .json</span></div>
                            <div class="input-group"><input type="file" id="file-upload" class="form-control" multiple accept=".zip,.json"><button class="btn btn-primary" id="btn-upload"><i class="bi bi-upload"></i></button></div>
                        </div>
                    </div>
                    <div class="mb-3"><div class="fw-bold small text-muted mb-2 px-1">地图存档 (Saves)</div><div id="file-list-map" class="list-group list-group-flush border rounded bg-white"></div></div>
                    <div><div class="fw-bold small text-muted mb-2 px-1">配置文件 (Configs)</div><div id="file-list-config" class="list-group list-group-flush border rounded bg-white"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="term-container">
            <div class="term-header">
                <div><i class="bi bi-terminal-fill me-2 text-primary"></i>控制台</div>
                <div><span id="ws-badge" class="badge bg-secondary me-3" style="font-weight: normal;">连接中断</span><button class="btn btn-sm btn-link text-muted p-0" onclick="term.clear()"><i class="bi bi-eraser"></i></button></div>
            </div>
            <div class="term-body"><div id="terminal"></div></div>
        </div>

        <div class="monitor-container" id="monitor-container">
            <div class="probe-header" onclick="toggleMonitor()">
                <span><i class="bi bi-activity me-2"></i>系统状态监控</span>
                <div class="d-flex align-items-center">
                    <span id="sys-uptime" class="fw-normal font-monospace me-3">运行时间: --</span>
                    <i id="monitor-toggle-icon" class="bi bi-chevron-up"></i>
                </div>
            </div>
            <div class="probe-body">
                <table class="yh-table">
                    <tr>
                        <td class="yh-label">处理器</td>
                        <td class="yh-bar-cell"><div class="progress-yh"><div id="yh-cpu-bar" class="bar bar-cpu" style="width: 0%"></div></div></td>
                        <td class="yh-val-cell"><span id="yh-cpu-txt">0%</span> <small class="text-muted" id="yh-cpu-model"></small></td>
                        <td class="yh-label">负载</td>
                        <td class="yh-val-cell" id="yh-load">0.00 0.00 0.00</td>
                    </tr>
                    <tr>
                        <td class="yh-label">内存</td>
                        <td class="yh-bar-cell">
                            <div class="progress-yh d-flex">
                                <div id="yh-mem-real" class="bar bar-mem" style="width: 0%" title="真实占用"></div>
                                <div id="yh-mem-buf" class="bar bar-buf" style="width: 0%" title="Buffers"></div>
                                <div id="yh-mem-cache" class="bar bar-cache" style="width: 0%" title="Cached"></div>
                            </div>
                        </td>
                        <td class="yh-val-cell" id="yh-mem-txt">0/0 MB</td>
                        <td class="yh-label">系统</td>
                        <td class="yh-val-cell small text-truncate" style="max-width: 150px;" id="yh-os">Linux</td>
                    </tr>
                    <tr>
                        <td class="yh-label">硬盘</td>
                        <td class="yh-bar-cell"><div class="progress-yh"><div id="yh-disk-bar" class="bar bar-disk" style="width: 0%"></div></div></td>
                        <td class="yh-val-cell" id="yh-disk-txt">0/0 GB</td>
                        <td class="yh-label">网络</td>
                        <td class="yh-val-cell small"><span class="text-success">↓ <span id="yh-net-rx">0</span></span> <span class="text-primary ms-2">↑ <span id="yh-net-tx">0</span></span></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<!-- 进度条 Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">操作进度</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="progressModalClose" disabled></button>
            </div>
            <div class="modal-body">
                <div class="mb-2" id="progressMessage">准备中...</div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="mt-2 text-end text-muted" id="progressDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="progressModalCancel" disabled>取消</button>
            </div>
        </div>
    </div>
</div>

<!-- Mod 门户 Modal -->
<div class="modal fade" id="modPortalModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Mod 门户</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="input-group mb-3"><span class="input-group-text">授权</span><input type="text" id="factorio-user" class="form-control" placeholder="用户名"><input type="password" id="factorio-token" class="form-control" placeholder="Token"></div><div class="input-group mb-3"><input type="text" id="portal-search" class="form-control" placeholder="输入 Mod 名字..." onkeydown="if(event.keyCode==13) searchModPortal()"><button class="btn btn-dark" onclick="searchModPortal()">搜索</button></div><div id="portal-results" class="list-group"></div></div></div></div></div>

<!-- 更新 Modal -->
<div class="modal fade" id="updateModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">更新服务</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><div class="row mb-3"><div class="col-6 border-end"><h6>稳定版</h6><h4 id="ver-stable" class="text-success">...</h4><button class="btn btn-sm btn-outline-success" onclick="installVer($('#ver-stable').text())">安装</button></div><div class="col-6"><h6>实验版</h6><h4 id="ver-exp" class="text-warning">...</h4><button class="btn btn-sm btn-outline-warning" onclick="installVer($('#ver-exp').text())">安装</button></div></div><div id="update-log" class="alert alert-secondary d-none text-start small"></div></div></div></div></div>

<!-- 物品库 Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Factorio 物品库 (2.0 + Space Age, 380+ 物品)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <input type="text" id="item-search" class="form-control mb-3 mx-3 mt-3" placeholder="搜索物品（支持中文/英文模糊匹配）..." onkeyup="filterItems()" autocomplete="off">
                <ul class="nav nav-tabs mb-0" id="itemTabs">
                    <li class="nav-item"><button class="nav-link active" onclick="renderItems('logistics')">物流 (45)</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="renderItems('production')">生产 (25)</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="renderItems('combat')">战斗 (30)</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="renderItems('intermediate')">中间产品 (25)</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="renderItems('energy')">能源 (15)</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="renderItems('module_science')">模块&科学 (20)</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="renderItems('armor_capsule')">装甲&胶囊 (10)</button></li>
                    <li class="nav-item"><button class="nav-link" onclick="renderItems('barrel_rail')">流体桶&轨道 (20)</button></li>
                </ul>
                <div id="item-grid" class="item-grid"></div>
            </div>
        </div>
    </div>
</div>

<script src="static/lib/bootstrap/js/bootstrap.bundle.js"></script>
<script src="static/lib/xterm/lib/xterm.js"></script>
<script src="static/lib/xterm/lib/xterm-addon-fit.js"></script>
<script src="static/lib/jquery-3.6.0.min.js"></script>

<script>
    async function checkAuth() {
        try {
            const res = await fetch('api.php?action=check_auth');
            const d = await res.json();
            if (!d.authenticated) {
                window.location.href = 'login.html';
            }
        } catch (e) {
            window.location.href = 'login.html';
        }
    }
    
    function logout() {
        if (confirm('确定要退出登录吗？')) {
            fetch('api.php?action=logout', { method: 'POST' })
                .then(() => window.location.href = 'login.html');
        }
    }

    // === 核心变量 ===
    let ITEMS = {}; // 物品库数据

    // === 页面初始化 ===
    function setSkin(skin) {
        const skinLink = document.getElementById('skin-style');
        const skinNames = {
            'default': '默认风格',
            'industrial': '现代风格',
            'factorio': 'Factorio风格'
        };
        if (skin === 'industrial') {
            skinLink.href = 'static/skins/industrial.css';
            localStorage.setItem('factorio-skin', 'industrial');
        } else if (skin === 'factorio') {
            skinLink.href = 'static/skins/factorio.css';
            localStorage.setItem('factorio-skin', 'factorio');
        } else {
            skinLink.href = '';
            localStorage.setItem('factorio-skin', 'default');
        }
        showToast('已切换到' + (skinNames[skin] || skin), 'success');
    }

    function loadSkin() {
        const savedSkin = localStorage.getItem('factorio-skin');
        if (savedSkin) {
            setSkin(savedSkin);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSkin();
        checkAuth();
        document.getElementById('server-address').innerText = window.location.hostname + ":34197";
        refreshMapList(); refreshConfigList(); loadAllFiles(); loadLocalVersions();
        setInterval(probe, 2000); probe();
        initItems(); // 加载物品库
        loadPlayerLists(); // 预加载玩家列表
        
        // Tab 事件监听
        document.querySelector('button[data-bs-target="#tab-mods"]').addEventListener('shown.bs-tab', loadMods);
        document.querySelector('button[data-bs-target="#tab-players"]').addEventListener('shown.bs-tab', loadPlayerLists);
        // 物品库 Modal 事件
        document.getElementById('itemModal').addEventListener('shown.bs.modal', () => renderItems('logistics'));
    });

    // === 物品库逻辑 (完整版) ===
    async function initItems() {
        try {
            const res = await fetch('static/items.json?t=' + Date.now()); // 防缓存
            ITEMS = await res.json();
            const total = Object.values(ITEMS).reduce((sum, cat) => sum + Object.keys(cat).length, 0);
            console.log(`%c物品库加载成功，共 ${total} 项 (Factorio 2.0 + Space Age)`, 'color:#10b981;font-weight:bold');
            showToast(`物品库加载完成 (${total} 项)`, 'success');
        } catch (e) {
            console.warn('items.json 加载失败，使用 fallback', e);
            ITEMS = {
                logistics: {"iron-plate":"铁板","copper-plate":"铜板","transport-belt":"传送带","inserter":"机械臂"},
                production: {"assembling-machine-2":"组装机2","electric-furnace":"电炉"},
                combat: {"pistol":"手枪","firearm-magazine":"黄弹"}
            };
            showToast('使用备用物品库 (3 项)', 'info');
        }
    }

    function renderItems(cat) {
        const g = document.getElementById('item-grid');
        g.innerHTML = '';
        const items = ITEMS[cat] || {};
        for (const [code, name] of Object.entries(items)) {
            const b = document.createElement('button');
            b.className = 'btn btn-outline-secondary item-btn h-100';
            b.innerHTML = `<div class="fw-bold small">${name}</div><div class="text-muted small font-monospace">${code}</div>`;
            b.onclick = () => {
                document.getElementById('gift-item').value = code;
                bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
                showToast(`已选择: ${name} (${code})`, 'info');
            };
            g.appendChild(b);
        }
        if (Object.keys(items).length === 0) g.innerHTML = '<div class="text-center text-muted p-4">暂无物品</div>';
        // 更新 tab active
        document.querySelectorAll('#itemTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function filterItems() {
        const t = document.getElementById('item-search').value.toLowerCase().trim();
        const g = document.getElementById('item-grid');
        g.innerHTML = '';
        let found = 0;
        for (const cat in ITEMS) {
            for (const [code, name] of Object.entries(ITEMS[cat])) {
                if (code.includes(t) || name.toLowerCase().includes(t)) {
                    const b = document.createElement('button');
                    b.className = 'btn btn-primary item-btn h-100';
                    b.innerHTML = `<div class="fw-bold small">${name}</div><div class="text-white small font-monospace">${code}</div>`;
                    b.onclick = () => {
                        document.getElementById('gift-item').value = code;
                        bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
                        showToast(`已选择: ${name} (${code})`, 'info');
                    };
                    g.appendChild(b);
                    found++;
                }
            }
        }
        if (found === 0) g.innerHTML = '<div class="col-12 text-center text-muted py-4"><i class="bi bi-search fs-1 mb-2"></i><p class="mb-0">未找到匹配物品</p></div>';
    }

    function doGift() {
        const n = document.getElementById('target-player').value.trim();
        const i = document.getElementById('gift-item').value.trim();
        const c = parseInt(document.getElementById('gift-count').value) || 1;
        if (!n || !i) return showToast('请填写玩家名和物品代码', 'error');
        if (confirm(`给玩家 "${n}" 投放 ${c} 个 "${i}"？（物品将掉落在玩家脚下）`)) {
            // 优化命令：使用 create_entity 掉落地面，避免 insert 失败
            const cmd = `/c local p = game.players["${n}"] if p and p.valid then p.surface.create_entity{name="item-on-ground", position=p.position, stack={name="${i}", count=${c}}} end`;
            const fd = new FormData();
            fd.append('cmd', cmd);
            apiCall('console', fd).then(() => showToast(`已向 "${n}" 投放 ${c} 个 "${i}"`, 'success'));
        }
    }

    // === 通用函数 ===
    function showToast(msg, type='info') {
        const bg = type==='error'?'bg-danger':type==='success'?'bg-success':'bg-primary';
        const t = document.createElement('div');
        t.className = `toast align-items-center text-white ${bg} border-0 show mb-2`;
        t.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        document.getElementById('toast-container').appendChild(t);
        new bootstrap.Toast(t).show();
        setTimeout(() => t.remove(), 3000);
    }

    async function apiCall(action, body = null, qs = '') {
        const fd = body instanceof FormData ? body : new FormData();
        if (!fd.has('action')) fd.append('action', action);
        try {
            const res = await fetch('api.php' + (qs || ''), { method: 'POST', body: fd });
            const d = await res.json();
            if (d.error) { showToast(d.error, 'error'); throw d.error; }
            if (d.message) showToast(d.message, 'success');
            return d;
        } catch (e) { showToast('请求失败: ' + e.message, 'error'); throw e; }
    }

    // === 系统探针 ===
    async function probe() {
        try {
            const res = await fetch('tz.php');
            const d = await res.json();
            document.getElementById('yh-cpu-bar').style.width = d.cpu_usage + '%';
            document.getElementById('yh-cpu-txt').innerText = d.cpu_usage + '%';
            document.getElementById('yh-cpu-model').innerText = `(${d.cpu_name})`;
            const m = d.mem;
            document.getElementById('yh-mem-real').style.width = (m.real_used / m.total * 100) + '%';
            document.getElementById('yh-mem-buf').style.width = (m.buffers / m.total * 100) + '%';
            document.getElementById('yh-mem-cache').style.width = (m.cached / m.total * 100) + '%';
            document.getElementById('yh-mem-txt').innerText = Math.round(m.real_used / 1024 / 1024) + '/' + Math.round(m.total / 1024 / 1024) + ' MB';
            document.getElementById('sys-uptime').innerText = `运行时间: ${fmt(d.uptime)}`;
            document.getElementById('yh-os').innerText = d.os;
            document.getElementById('yh-load').innerText = d.load.join(' ');
            document.getElementById('yh-disk-bar').style.width = d.disk.percent + '%';
            document.getElementById('yh-disk-txt').innerText = d.disk.used + '/' + d.disk.total + ' GB';
            document.getElementById('yh-net-rx').innerText = fmtBytes(d.net.rx);
            document.getElementById('yh-net-tx').innerText = fmtBytes(d.net.tx);
            updateAppStatus(d.app_running);
        } catch (e) { console.error('探针失败', e); }
    }

    function updateAppStatus(run) {
        const b = document.getElementById('server-status-badge');
        if (run) {
            b.className = 'badge bg-success';
            b.innerText = '运行中';
            document.getElementById('stop-area').classList.remove('d-none');
            document.getElementById('startForm').classList.add('d-none');
        } else {
            b.className = 'badge bg-secondary';
            b.innerText = '已停止';
            document.getElementById('stop-area').classList.add('d-none');
            document.getElementById('startForm').classList.remove('d-none');
        }
    }

    function fmt(s) {
        const d = Math.floor(s / 86400), h = Math.floor((s % 86400) / 3600), m = Math.floor((s % 3600) / 60);
        return `${d}d ${h}h ${m}m`;
    }

    function fmtBytes(b) {
        if (b === 0) return '0 B';
        const k = 1024, i = Math.floor(Math.log(b) / Math.log(k));
        return parseFloat((b / Math.pow(k, i)).toFixed(1)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
    }

    // === Mod 管理 ===
    async function loadMods() {
        try {
            const res = await fetch('api.php?action=mod_list');
            const d = await res.json();
            const el = document.getElementById('mod-list');
            el.innerHTML = '';
            if (!d.mods || !d.mods.length) {
                el.innerHTML = '<div class="text-center p-3 text-muted">暂无模组</div>';
                return;
            }
            d.mods.forEach(m => {
                const isDlc = m.filename === '[官方 DLC]';
                const delBtn = isDlc ? '' : `<button class="btn btn-sm btn-link text-danger p-0 ms-3" onclick="delMod('${m.filename}')"><i class="bi bi-trash"></i></button>`;
                const checked = m.enabled ? 'checked' : '';
                el.innerHTML += `
                    <div class="mod-item">
                        <div class="text-truncate" style="flex:1">
                            <div class="mod-name ${m.enabled ? '' : 'text-muted'}">${m.name}</div>
                            <div class="mod-file small">${m.filename}</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" ${checked} onchange="toggleMod('${m.name}', this.checked)"></div>${delBtn}
                        </div>
                    </div>`;
            });
        } catch (e) { showToast('加载模组失败', 'error'); }
    }

    function filterLocalMods() {
        const t = document.getElementById('local-mod-filter').value.toLowerCase();
        document.querySelectorAll('.mod-item').forEach(el => {
            const n = el.querySelector('.mod-name').innerText.toLowerCase();
            el.style.display = n.includes(t) ? 'flex' : 'none';
        });
    }

    async function toggleMod(n, e) {
        const fd = new FormData();
        fd.append('name', n);
        fd.append('enabled', e);
        await apiCall('mod_toggle', fd);
        loadMods(); // 刷新列表
    }

    async function uploadMod() {
        const inp = document.getElementById('mod-upload-input');
        if (inp.files.length === 0) return showToast('请选择 .zip 文件', 'error');
        const fd = new FormData();
        for (let f of inp.files) fd.append('file[]', f);
        fd.append('action', 'mod_upload');
        const btn = document.querySelector('button[onclick="uploadMod()"]');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 上传中...';
        try {
            await apiCall('mod_upload', fd);
            inp.value = '';
            loadMods();
            showToast('模组上传成功', 'success');
        } catch (e) {
            showToast('上传失败', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '本地上传';
        }
    }

    async function delMod(f) {
        if (!confirm(`确认删除模组 "${f}"？`)) return;
        const fd = new FormData();
        fd.append('filename', f);
        fd.append('action', 'mod_delete');
        await apiCall('mod_delete', fd);
        loadMods();
    }

    // === Mod 门户 ===
async function searchModPortal() {
    const q = document.getElementById('portal-search').value.trim();
    const list = document.getElementById('portal-results');
    list.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div><small>搜索中...</small></div>';

    try {
        const url = `api.php?action=mod_portal_search${q ? '&q=' + encodeURIComponent(q) : ''}`;
        const res = await fetch(url);
        const data = await res.json();

        list.innerHTML = '';
        if (!data.results || data.results.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-3">未找到 Mod</div>';
            return;
        }

        data.results.forEach(m => {
            list.innerHTML += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex:1">
                            <h6 class="mb-1 text-primary fw-bold">${m.title || m.name} <small class="text-muted">v${m.latest_release ? m.latest_release.version : 'N/A'}</small></h6>
                            <p class="mb-1 small text-secondary">${m.summary || 'No description'}</p>
                            <small class="text-muted">下载: ${m.downloads_count || 0} | 作者: ${m.owner || 'Unknown'}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="installModFromPortal('${m.name}')">安装</button>
                    </div>
                </div>`;
        });
    } catch (e) {
        list.innerHTML = '<div class="text-danger text-center py-3">搜索失败: ' + e.message + '</div>';
    }
}

    async function installModFromPortal(name) {
        const u = document.getElementById('factorio-user').value.trim();
        const t = document.getElementById('factorio-token').value.trim();
        if (!u || !t) return showToast('请填写用户名和 Token', 'error');
        if (!confirm(`从 Mod 门户下载并安装 "${name}"？`)) return;
        const fd = new FormData();
        fd.append('name', name);
        fd.append('username', u);
        fd.append('token', t);
        fd.append('action', 'mod_portal_install');
        await apiCall('mod_portal_install', fd);
        bootstrap.Modal.getInstance(document.getElementById('modPortalModal')).hide();
        loadMods();
    }

    // === 文件管理 ===
    // 刷新存档列表时，顺便显示历史记录
async function refreshMapList() {
    const r = await fetch('api.php?action=files&type=map');
    const d = await r.json();
    const sel = document.getElementById('map-select');
    const hist = document.getElementById('save-history');
    
    sel.innerHTML = '<option disabled>加载中...</option>';
    hist.innerHTML = '';

    if (!d.files || !d.files.length) {
        sel.innerHTML = '<option disabled>无存档</option>';
        return;
    }

    d.files.forEach(f => {
        // 下拉菜单
        const opt = new Option(`${f.display || f.filename} (${f.size}MB)`, f.filename);
        if (f.is_current) opt.selected = true;
        sel.add(opt);

        // 历史列表
        const active = f.is_current ? 'list-group-item-success' : '';
        hist.innerHTML += `
            <a href="javascript:void(0)" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ${active}">
                <div>
                    <div class="fw-600">${f.display || f.filename}</div>
                    <small class="text-muted">${new Date(f.time*1000).toLocaleString()} · ${f.size} MB</small>
                </div>
                ${!f.is_current ? `<button class="btn btn-sm btn-outline-primary" onclick="useThisSave('${f.filename}', ${f.size})">使用此存档</button>` : '<span class="badge bg-success">当前使用</span>'}
            </a>`;
    });
}

// 进度条控制函数
function showProgressModal(message) {
    document.getElementById('progressMessage').textContent = message;
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').ariaValueNow = 0;
    document.getElementById('progressDetails').textContent = '';
    document.getElementById('progressModalClose').disabled = true;
    document.getElementById('progressModalCancel').disabled = true;
    
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
}

function updateProgress(percent, details) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressBar').ariaValueNow = percent;
    if (details) {
        document.getElementById('progressDetails').textContent = details;
    }
}

function hideProgressModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
    if (modal) {
        modal.hide();
    }
}

// 一键切换存档（回档）
async function useThisSave(name, sizeMB) {
    if (!confirm(`确认切换到存档：${name}？\n\n存档大小：${sizeMB} MB\n复制可能需要一些时间，请耐心等待。`)) {
        return;
    }
    
    showProgressModal('正在切换存档...');
    
    // 使用 SSE 接收实时进度
    const fd = new FormData();
    fd.append('filename', name);
    fd.append('realtime', 'true');
    
    try {
        const url = 'api.php?action=set_current_save';
        const response = await fetch(url, {
            method: 'POST',
            body: fd
        });
        
        if (!response.ok) {
            throw new Error('网络错误');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            
            // 处理接收到的数据
            const lines = buffer.split('\n');
            for (let i = 0; i < lines.length - 1; i++) {
                const line = lines[i].trim();
                if (line.startsWith('event: progress')) {
                    const dataLine = lines[i + 1];
                    if (dataLine.startsWith('data: ')) {
                        const data = JSON.parse(dataLine.substring(6));
                        updateProgress(data.progress, `复制中... ${data.progress.toFixed(1)}%`);
                    }
                } else if (line.startsWith('event: complete')) {
                    const dataLine = lines[i + 1];
                    if (dataLine.startsWith('data: ')) {
                        const data = JSON.parse(dataLine.substring(6));
                        if (data.status === 'success') {
                            showToast(data.message || '存档切换成功！', 'success');
                            refreshMapList();
                        } else {
                            showToast(data.error || '切换失败', 'error');
                        }
                        hideProgressModal();
                        return;
                    }
                } else if (line.startsWith('event: error')) {
                    const dataLine = lines[i + 1];
                    if (dataLine.startsWith('data: ')) {
                        const data = JSON.parse(dataLine.substring(6));
                        showToast(data.error || '切换失败', 'error');
                        hideProgressModal();
                        return;
                    }
                }
            }
            
            // 保留未处理的部分
            buffer = lines[lines.length - 1];
        }
    } catch (e) {
        showToast('切换存档失败：' + (e.message || '未知错误'), 'error');
        hideProgressModal();
    }
}
    async function refreshConfigList() { loadDropdown('config', 'config-select'); }

    async function loadDropdown(type, id) {
        try {
            const r = await fetch(`api.php?action=files&type=${type}`);
            const d = await r.json();
            const s = document.getElementById(id);
            s.innerHTML = '';
            if (d.files && d.files.length) {
                d.files.forEach(f => s.innerHTML += `<option value="${f.filename}">${f.filename}</option>`);
                s.selectedIndex = 0;
            } else {
                s.innerHTML = '<option disabled>无文件</option>';
            }
        } catch (e) { showToast('加载列表失败', 'error'); }
    }

    async function loadAllFiles() {
        loadFiles('map', 'file-list-map');
        loadFiles('config', 'file-list-config');
    }

    async function loadFiles(type, id) {
        try {
            const r = await fetch(`api.php?action=files&type=${type}`);
            const d = await r.json();
            const el = document.getElementById(id);
            el.innerHTML = '';
            if (!d.files || !d.files.length) {
                el.innerHTML = '<div class="text-center text-muted small py-2">无文件</div>';
                return;
            }
            d.files.forEach(f => {
                const dl = type !== 'config' ? `<a href="api.php?action=download&filename=${f.filename}&type=${type}" class="btn btn-sm btn-link text-success p-0 me-2" download><i class="bi bi-download"></i></a>` : '';
                el.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="flex-grow-1">${f.filename}</span>
                        <div>${dl}<button onclick="delFile('${f.filename}','${type}')" class="btn btn-sm btn-link text-danger p-0"><i class="bi bi-trash"></i></button></div>
                    </div>`;
            });
        } catch (e) { showToast('加载文件失败', 'error'); }
    }

    window.delFile = async (n, t) => {
        if (!confirm(`确认删除 "${n}"？`)) return;
        const fd = new FormData();
        fd.append('filename', n);
        fd.append('type', t);
        fd.append('action', 'delete_file');
        await apiCall('delete_file', fd);
        loadAllFiles();
        refreshMapList();
        refreshConfigList();
    };

    // === 玩家管理 ===
    async function loadPlayerLists() {
        try {
            const r = await fetch('api.php?action=player_lists');
            const d = await r.json();
            console.log('玩家列表数据:', d);
            
            const fillList = (id, list) => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn('元素未找到:', id);
                    return;
                }
                
                const playerList = Array.isArray(list) ? list : [];
                console.log(`填充 ${id}:`, playerList);
                
                el.innerHTML = playerList.map(p => {
                    const name = typeof p === 'string' ? p : (p.username || p.name || '');
                    if (!name) return '';
                    
                    const safeName = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `<button class="list-group-item list-group-item-action py-1 small" onclick="document.getElementById('target-player').value='${safeName}'; document.getElementById('target-player').focus();">${name}</button>`;
                }).filter(Boolean).join('') || '<div class="text-center text-muted small p-2">无记录</div>';
            };
            
            fillList('list-admins', d.admins);
            fillList('list-bans', d.bans);
            fillList('list-whitelist', d.whitelist);
            
            showToast('玩家列表已刷新', 'success');
        } catch (e) {
            console.error('加载玩家列表失败:', e);
            showToast('加载玩家列表失败: ' + (e.message || e), 'error');
        }
    }

    function doAction(type) {
        const n = document.getElementById('target-player').value.trim();
        if (!n) return showToast('请输入玩家名', 'error');
        const cmds = {
            ban: `/ban ${n}`,
            kick: `/kick ${n}`,
            unban: `/unban ${n}`,
            promote: `/promote ${n}`,
            'wl-add': `/whitelist add ${n}`,
            'wl-remove': `/whitelist remove ${n}`
        };
        if (!confirm(`确认执行 "${type}" 操作于 "${n}"？`)) return;
        const fd = new FormData();
        fd.append('cmd', cmds[type]);
        fd.append('action', 'console');
        apiCall('console', fd).then(() => setTimeout(loadPlayerLists, 1000));
    }

    // === 服务器控制 ===
window.controlServer = async (act) => {
    try {
        const fd = new FormData(document.getElementById('startForm'));
        fd.append('action', act);
        const res = await apiCall(act, fd);
        // 无论 error 或 message，都显示（已优化后端返回 message）
        if (res.message) showToast(res.message, 'info');  // info 而非 error，避免抛异常
        probe(); // 刷新状态
    } catch (e) {
        console.error('Server control failed:', e);
        showToast('操作失败: ' + (e || '未知错误'), 'error');
    }
};

    window.saveGame = async () => {
        const fd = new FormData();
        fd.append('cmd', '/save');
        fd.append('action', 'console');
        await apiCall('console', fd);
    };

    // === 版本更新 ===
    async function checkUpdate() {
        const modal = new bootstrap.Modal(document.getElementById('updateModal'));
        modal.show();
        document.getElementById('ver-stable').innerText = '...';
        document.getElementById('ver-exp').innerText = '...';
        document.getElementById('update-log').classList.add('d-none');
        try {
            const r = await fetch('api.php?action=update_check');
            const d = await r.json();
            
            document.getElementById('ver-stable').innerText = d.stable || 'N/A';
            document.getElementById('ver-exp').innerText = d.experimental || 'N/A';
            
            const updateLog = document.getElementById('update-log');
            updateLog.classList.remove('d-none');
            
            let logHtml = '<div class="mb-2"><strong>当前版本：</strong> ' + (d.current || 'unknown') + '</div>';
            
            if (d.stable && d.current && d.current !== 'unknown') {
                if (versionCompare(d.stable, d.current) > 0) {
                    logHtml += '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>发现新版本！稳定版 v' + d.stable + ' 可用</div>';
                } else if (d.stable === d.current) {
                    logHtml += '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>当前已是最新版本</div>';
                } else {
                    logHtml += '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>当前版本比最新稳定版还要新</div>';
                }
            }
            
            updateLog.innerHTML = logHtml;
        } catch (e) { 
            showToast('检查更新失败', 'error'); 
            document.getElementById('update-log').classList.remove('d-none');
            document.getElementById('update-log').innerHTML = '<div class="alert alert-danger">检查更新失败: ' + (e.message || '未知错误') + '</div>';
        }
    }
    
    function versionCompare(v1, v2) {
        const parts1 = v1.split('.').map(Number);
        const parts2 = v2.split('.').map(Number);
        
        for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
            const p1 = parts1[i] || 0;
            const p2 = parts2[i] || 0;
            if (p1 > p2) return 1;
            if (p1 < p2) return -1;
        }
        return 0;
    }

    async function installVer(v) {
        if (!v || !confirm(`确认安装版本 "${v}"？服务器将重启。`)) return;
        const log = document.getElementById('update-log');
        log.classList.remove('d-none');
        log.innerText = '下载中...';
        const fd = new FormData();
        fd.append('version', v);
        fd.append('action', 'update_install');
        try {
            await apiCall('update_install', fd);
            log.innerText = '安装成功！请重启服务器。';
            loadLocalVersions();
            showToast('版本安装成功', 'success');
        } catch (e) {
            log.innerText = '安装失败: ' + e.message;
            showToast('安装失败', 'error');
        }
    }

    async function loadLocalVersions() {
        try {
            const r = await fetch('api.php?action=get_versions');
            const d = await r.json();
            const s = document.getElementById('version-select');
            s.innerHTML = '';
            if (d.versions && d.versions.length) {
                d.versions.forEach(v => s.innerHTML += `<option value="${v.id}">${v.name}</option>`);
                s.selectedIndex = 0;
            } else {
                s.innerHTML = '<option disabled>无版本</option>';
            }
        } catch (e) { showToast('加载版本失败', 'error'); }
    }

// 折叠/展开监控面板
function toggleMonitor() {
    const container = document.getElementById('monitor-container');
    const icon = document.getElementById('monitor-toggle-icon');
    container.classList.toggle('collapsed');
    if (container.classList.contains('collapsed')) {
        icon.className = 'bi bi-chevron-down';
    } else {
        icon.className = 'bi bi-chevron-up';
    }
    setTimeout(() => fitAddon.fit(), 350);
}

// ==================== 永久日志终端（完美换行 + 永不掉线 + 刷新不丢）===================
const term = new Terminal({
    fontSize: 12,
    lineHeight: 1.2,
    fontFamily: 'Consolas, Menlo, monospace',
    theme: { background: '#1e1e1e', foreground: '#cccccc' },
    cursorBlink: true,
    scrollback: 100000,
    convertEol: true
});

const fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);

let sse = null;
let historyLoaded = false;

// 加载历史日志
async function loadHistory() {
    try {
        const r = await fetch('api.php?action=log_tail&lines=5000');
        const t = await r.text();
        if (t.trim()) term.write(t.replace(/\n/g, '\r\n'));
        term.scrollToBottom();
        historyLoaded = true;
        badge('历史日志已加载', 'bg-info');
    } catch (e) {
        term.write('\r\n[提示] 暂无历史日志\r\n');
    }
}

// 实时日志（完美换行版）
function startSSE() {
    if (sse) return;
    sse = new EventSource('log_ws.php');

    sse.onopen = () => badge('实时日志已连接', 'bg-success');

    sse.onmessage = (e) => {
        // 关键在这里：去掉 "data: " 前缀，只保留真实日志内容
        let line = e.data;
        if (line.startsWith('data: ')) {
            line = line.substring(6);  // 去掉 "data: "
        }
        if (line === '[CONNECTED] 实时日志已连接') return;

        term.write(line + '\r\n');  // 每条日志强制换行
        if (historyLoaded) term.scrollToBottom();
    };

    sse.onerror = () => {
        sse.close();
        sse = null;
        badge('实时日志断开（3秒后重连）', 'bg-danger');
        setTimeout(startSSE, 3000);
    };
}

function badge(text, cls) {
    const b = document.getElementById('ws-badge');
    if (b) {
        b.textContent = text;
        b.className = `badge ${cls} me-3`;
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    const box = document.getElementById('terminal');
    term.open(box);
    fitAddon.fit();

    loadHistory();
    startSSE();

    window.addEventListener('resize', () => setTimeout(() => fitAddon.fit(), 100));
});

// 清屏
term.clear = () => term.reset();



    // === 文件上传 ===
    document.getElementById('btn-upload').onclick = async () => {
        const inp = document.getElementById('file-upload');
        if (inp.files.length === 0) return showToast('请选择文件', 'error');
        const fd = new FormData();
        for (let f of inp.files) fd.append('file[]', f);
        fd.append('action', 'upload');
        const btn = document.getElementById('btn-upload');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        try {
            await apiCall('upload', fd);
            inp.value = '';
            loadAllFiles();
            refreshMapList();
            refreshConfigList();
            showToast('文件上传成功', 'success');
        } catch (e) {
            showToast('上传失败', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-upload"></i>';
        }
    };
</script>
</body>
</html>